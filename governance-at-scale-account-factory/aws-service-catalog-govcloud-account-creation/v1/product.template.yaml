# Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
AWSTemplateFormatVersion: '2010-09-09'
Description: |
  account-bootstrap-shared-product and account-creation-shared-product must both be provisioned into the same accountbefore this will work - they build some resources needed for this to work and they provision the SSM params with thecorrect ARNs so this works with no copy and pasting.Provisioning this template will create an AWS Account and bootstrap it using aws-service-catalog-puppet so you canprovision products into the account.
  {"framework": "servicecatalog-products", "role": "product", "product-set": "governance-at-scale-account-factory", "product": "aws-service-catalog-account-creation", "version": "v1"}
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Account Details
        Parameters:
          - AccountName
          - Email
          - AccountGroup
          - AccountType
          - IamUserAccessToBilling
          - OrganizationAccountAccessRole
      - Label:
          default: Lambda ARNs
        Parameters:
          - GovernanceAtScaleAccountFactoryAccountCreationCRArn
          - GovernanceAtScaleAccountFactoryAccountCreateUpdateNotifierCRArn
          - GovernanceAtScaleAccountFactoryGovCloudAccountCreateUpdateNotifierCRArn
          - GovernanceAtScaleAccountFactoryAccountTypeToOUChooserCRArn
          - GovernanceAtScaleAccountFactoryMoveToOUArn
          - GovernanceAtScaleAccountFactoryAccountWaiterArn
          - GovernanceAtScaleAccountFactoryBootstrapperProjectCustomResourceArn
      - Label: 
          default: Service Catalog Puppet
        Parameters:
          - ServiceCatalogPuppetVersion
    ParameterLabels:
      AccountName:
        default: Account Name
      Email:
        default: Account Email Address
      AccountGroup:
        default: Account Group
      AccountType:
        default: Account Type
      IamUserAccessToBilling: 
        default: User Access to Billing
      OrganizationAccountAccessRole:
        default: Organization Account Access IAM Role Name
      GovernanceAtScaleAccountFactoryAccountCreationCRArn:
        default: Account Creation Lambda ARN
      GovernanceAtScaleAccountFactoryAccountCreateUpdateNotifierCRArn:
        default: Commericial Account Notifier ARN
      GovernanceAtScaleAccountFactoryGovCloudAccountCreateUpdateNotifierCRArn:
        default: GovCloud Account Notifier ARN
      GovernanceAtScaleAccountFactoryAccountTypeToOUChooserCRArn:
        default: Account Type to OU Lambda ARN
      GovernanceAtScaleAccountFactoryMoveToOUArn:
        default: Move to OU Lambda ARN
      GovernanceAtScaleAccountFactoryAccountWaiterArn:
        default: Account Waiter Lambda ARN
      GovernanceAtScaleAccountFactoryBootstrapperProjectCustomResourceArn:
        default: Bootstraper Lambda ARN
      ServiceCatalogPuppetVersion:
        default: Service Catalog Puppet Version

Parameters:
  Email:
    Type: String
    Description: The email address to use for the GovCloud and Commerical accounts that are to be created
  AccountName:
    Type: String
    Description: The name to use for the accounts that are to be created
  OrganizationAccountAccessRole:
    Type: String
    Default: OrganizationAccountAccessRole
    Description: The name of the role to be created in the account that allows Organizations access
  IamUserAccessToBilling:
    Type: String
    Default: "ALLOW"
    AllowedValues: ['ALLOW', 'DENY']
    Description: If set to ALLOW, the new linked account in the commercial Region enables IAM users to access account billing information if they have the required permissions. If set to DENY, only the root user of the new account can access account billing information.
  AccountGroup:
    Type: String
    Description: >-
      Which platform does the account belong to
    AllowedValues:
      - Security
      - Infrastructure
      - Workload
  AccountType:
    Type: String
    Description: >-
      Which stage of the SDLC is the account going to be used for
    AllowedValues:
      - dev
      - test
      - preprod
      - prod
  GovernanceAtScaleAccountFactoryAccountCreationCRArn:
    Type: String
    Description: The ARN for the lambda function that creates the accounts
  GovernanceAtScaleAccountFactoryMoveToOUArn:
    Type: String
    Description: The ARN of the lambda function that moves the new commercial account to the correct organizational unit
  GovernanceAtScaleAccountFactoryAccountWaiterArn:
    Type: String
    Description: The ARN of the lambda function that waits for CodeBuild and CloudFormation to become available in the new commercial account
  GovernanceAtScaleAccountFactoryBootstrapperProjectCustomResourceArn:
    Type: String
    Description: The ARN of the lambda function that will bootstrap the new commerical account as a spoke of the current Service Catalog Puppet account
  GovernanceAtScaleAccountFactoryAccountTypeToOUChooserCRArn:
    Type: String
    Description: The ARN of the lambda that converts the account group and account type to the correct organizational unit
  GovernanceAtScaleAccountFactoryAccountCreateUpdateNotifierCRArn:
    Type: String
    Description: The ARN of the lambda that will dispatch SNS notifications on account creation / update of the Commerical account
  GovernanceAtScaleAccountFactoryGovCloudAccountCreateUpdateNotifierCRArn:
    Type: String
    Description: The ARN of the lambda that will dispatch SNS notifications on account creation / update of the GovCloud account
  ServiceCatalogPuppetVersion:
    Type: String
    Description: The version of service catalog puppet in use

Resources:
  # Lambda function that returns the OU identifier for the given account type and group
  # This is for the Commercial account
  OUDetails:
    Type: Custom::Resource
    DeletionPolicy: Retain
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryAccountTypeToOUChooserCRArn
      AccountType: !Ref AccountType
      AccountGroup: !Ref AccountGroup
      AccountPartition: Commercial

  # Lambda function that creates the Commercial and GovCloud accounts
  Account:
    Type: Custom::Resource
    Description: A custom resource representing an AWS Account
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryAccountCreationCRArn
      Email: !Ref Email
      AccountName: !Ref AccountName
      IamUserAccessToBilling: !Ref IamUserAccessToBilling
      AccountPartition: GovCloud

  # Lambda function that moves the Commerical account to the correct OU
  MoveToOU:
    Type: Custom::Resource
    Description: A custom resource for moving an account to an OU
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryMoveToOUArn
      AccountType: !Ref AccountType
      AccountGroup: !Ref AccountGroup
      TargetOU: !GetAtt OUDetails.OrganizationalUnitName
      AccountId: !GetAtt Account.account_id


  AccountWaiterConditionHandle1:
    Type: AWS::CloudFormation::WaitConditionHandle
    Properties: {}

  # Lambda function that triggers a CodeBuild project which in turn executes
  # the servicecatalog-puppet CLI and waits for CloudFormation and CodeBuild
  # to become available in the Commercial account
  AccountWaiter1:
    Type: Custom::Resource
    Description: A custom resource for waiting for an account to become active
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryAccountWaiterArn
      AccountId: !GetAtt Account.account_id
      ServiceCatalogPuppetVersion: !Ref ServiceCatalogPuppetVersion
      Handle: !Ref AccountWaiterConditionHandle1
      AccountPartition: aws

  AccountWaiterCondition1:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: AccountWaiter1
    Properties:
      Handle: !Ref AccountWaiterConditionHandle1
      Timeout: 28800

  # Lambda function that sends a notification that the 
  # Commercial account was created
  Notifier:
    Type: Custom::Resource
    DeletionPolicy: Retain
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryAccountCreateUpdateNotifierCRArn
      AccountName: !Ref AccountName
      AccountEmail: !Ref Email
      ManagedOrganizationalUnit: !GetAtt OUDetails.OrganizationalUnitName
      AccountId: !GetAtt Account.account_id
      
  # Lambda function that sends a notification that the 
  # GovCloud account was created
  GovCloudNotifier:
    Type: Custom::Resource
    DeletionPolicy: Retain
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryGovCloudAccountCreateUpdateNotifierCRArn
      AccountName: !Ref AccountName
      AccountEmail: !Ref Email
      ManagedOrganizationalUnit: GovCloud acccount - needs to be moved to the correct OU
      AccountId: !GetAtt Account.govcloud_account_id

  AccountBootstrapConditionHandle1:
    Type: AWS::CloudFormation::WaitConditionHandle
    Properties: {}

  # Lambda function that bootstraps the new Commercial account for 
  # Service Catalog Puppet by running servicecatalog-puppet bootstrap-spoke-as
  Bootstrap:
    Type: Custom::CustomResource
    DependsOn: AccountWaiter1
    Properties:
      ServiceToken: !Ref GovernanceAtScaleAccountFactoryBootstrapperProjectCustomResourceArn
      OrganizationAccountAccessRoleName: !Ref OrganizationAccountAccessRole
      TargetAccountId: !GetAtt Account.account_id
      PuppetAccountId: !Sub "${AWS::AccountId}"
      Handle: !Ref AccountBootstrapConditionHandle1
      AccountPartition: aws

  AccountBootstrapCondition1:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: Bootstrap
    Properties:
      Handle: !Ref AccountBootstrapConditionHandle1
      Timeout: 28800

Outputs:
  AccountId:
    Description: The Account ID for the new commercial account
    Value: !GetAtt Account.account_id
  GovCloudAccountId:
    Description: The Account ID for the new GovCloud account
    Value: !GetAtt Account.govcloud_account_id