# Copyright 2021 Amazon.com Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Product that zips up code commit repo when a cloudwatch commit event occurs the zip is added to an s3 bucket.
  {"framework": "servicecatalog-products", "role": "product", "product-set": "operations", "product": "codecommit-sns-notifier", "version": "v1"}

Parameters:
  pServiceCatalogCodeCommitSnsNotifyEmail:
    Type: String
    Description: Target E-mail address for SNS Notifications to be sent to

Resources:
# sns topic for notifications
  rSnsTopic:
    Type: AWS::SNS::Topic
    Properties: 
      DisplayName: codebuild-notify
      TopicName: codebuild-notify

  # sns subscription for notifications
  rSnsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint:
        Ref: pServiceCatalogCodeCommitSnsNotifyEmail
      Protocol: email
      TopicArn:
        Ref: rSnsTopic

  # policy to allow cloudwatch to publish to sns
  rEventTopicPolicy:
    Type: 'AWS::SNS::TopicPolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: 'sns:Publish'
            Resource: !Ref rSnsTopic
      Topics:
        - !Ref rSnsTopic

  # SNS notification Cloudwatch rule
  rCloudwatchNotifyRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Cloudwatch rule that watches for codebuild events
      Name: codebuild-build-notify
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          build-status:
            - FAILED
            - STOPPED
      Targets:
        - Arn: !Ref rSnsTopic
          Id: codebuild-trigger-notify
          InputTransformer:
            InputPathsMap: {"build-id":"$.detail.build-id","project-name":"$.detail.project-name","build-status":"$.detail.build-status"}
            InputTemplate: |
              "Build '<build-id>' for build project '<project-name>' has reached the build status of '<build-status>'."

Outputs:
  oSnsTopic:
    Description: SNS Topic Arn
    Value: !Ref  rSnsTopic
  oSnsSubscription:
    Description: SNS Subscription Arn
    Value: !Ref rSnsSubscription