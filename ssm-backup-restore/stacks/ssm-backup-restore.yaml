# Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

Schema: factory-2019-04-01
Stacks:
  - Name: ssm-backup
    Tags:
      - Key: product-type
        Value: ssm-backup
    Versions:
      - Name: v1
        Options:
          ShouldCFNNag: True
        Source:
          Provider: CodeCommit
          Configuration:
            RepositoryName: ssm-backup
            BranchName: v1
    BuildSpec: |
      version: 0.2
      phases:
        install:
          runtime-versions:
            python: 3.8
        build:
          commands:
            - pip install -r requirements.txt -t src
          {% for region in ALL_REGIONS %}
            - aws cloudformation package --template $(pwd)/product.template.yaml --s3-bucket sc-factory-artifacts-${ACCOUNT_ID}-{{ region }} --s3-prefix ${STACK_NAME} --output-template-file product.template-{{ region }}.yaml
          {% endfor %}
      artifacts:
        files:
          - '*'
          - '**/*'

  - Name: ssm-restore
    Tags:
      - Key: product-type
        Value: ssm-restore
    Versions:
      - Name: v1
        Options:
          ShouldCFNNag: True
        Source:
          Provider: CodeCommit
          Configuration:
            RepositoryName: ssm-restore
            BranchName: v1
    BuildSpec: |
      version: 0.2
      phases:
        install:
          runtime-versions:
            python: 3.8
        build:
          commands:
            - pip install -r requirements.txt -t src
          {% for region in ALL_REGIONS %}
            - aws cloudformation package --template $(pwd)/product.template.yaml --s3-bucket sc-factory-artifacts-${ACCOUNT_ID}-{{ region }} --s3-prefix ${STACK_NAME} --output-template-file product.template-{{ region }}.yaml
          {% endfor %}
      artifacts:
        files:
          - '*'
          - '**/*'